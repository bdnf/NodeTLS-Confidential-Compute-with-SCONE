# NodeJS TLS example with certificates auto-generated by CAS

Example demonstrates how to start simple NodeJS server with TLS certificate and key dynamically injected from CAS.

The CAS service can also generate secrets and certificates automatically. Combined with access policies, it means that such auto-generated secrets and certificates will be seen only by certain applications. No human (e.g. a system operator) will ever see them: they only exist inside of SGX enclaves.

# Steps
`Makefile` in root directory demonstrates all necessary steps to run the application with local CAS and LAS instances

1. Build images.
```
  make build
```
2. Start CAS and LAS services
```
  make cas-las
```
3. To setup remote attestation, you will need a session file and the **MRENCLAVE**, which is a unique signature of your application. Extract **MRENCLAVE** of your application by running its container with the environment variable SCONE_HASH set to 1.
```
  make hash
```
4. Create a Session file to be submitted to CAS.
The certificates are defined in the `secrets` field, and are injected into the filesystem through `images.injection_files`.

Paste correct **MRENCLAVE** (from previous step) into `session.yaml` file into `services.mrenclaves[0]`.
Currently set to: `[e9744ef0e1123da5772b4440bc186c6bf19cad257d326215dfdf76cdb93c83d8]`

5. Now, post the session file to your CAS of choice:
```
  make submit-session
```

6. Test the application
```
  make example
```
Note! if the `SCONE_NO_FS_SHIELD` is set application will fail.
`Ctrl+C` to stop the application.

7. If the previous step failed, manually update the application and rerun.

This step will create new interactive container with open `bash` shell
```
  make example-debug

  # Inside the container run:
  unset SCONE_NO_FS_SHIELD
  node /app/app.js
```
8. Cleanup
```
  make clean
```
